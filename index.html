<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Earn Master</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        :root {
            --primary: #5e72e4;
            --secondary: #825ee4;
            --accent: #f5365c;
            --success: #2dce89;
            --info: #11cdef;
            --warning: #fb6340;
            --light: #f4f5f7;
            --dark: #212529;
            --white: #ffffff;
            --gray: #8898aa;
            --gradient-primary: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
            --gradient-secondary: linear-gradient(135deg, #825ee4 0%, #f5365c 100%);
            --gradient-success: linear-gradient(135deg, #2dce89 0%, #11cdef 100%);
            --gradient-info: linear-gradient(135deg, #11cdef 0%, #2dce89 100%);
            --gradient-warning: linear-gradient(135deg, #fb6340 0%, #f5365c 100%);
            --shadow-sm: 0 0 .5rem rgba(0,0,0,.075);
            --shadow: 0 0 2rem 0 rgba(136,152,170,.15);
            --shadow-lg: 0 0 3rem rgba(0,0,0,.175);
            --border-radius: 0.375rem;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Login Styles */
        #login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow: hidden;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,197.3C1248,203,1344,149,1392,122.7L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
            background-size: cover;
            opacity: 0.2;
        }
        
        .login-box {
            background: var(--white);
            padding: 40px;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
            z-index: 1;
            transform: translateY(0);
            transition: var(--transition);
        }
        
        .login-box:hover {
            transform: translateY(-5px);
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: var(--white);
            font-size: 2rem;
            box-shadow: var(--shadow);
        }
        
        .login-box h2 {
            color: var(--dark);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .login-box p {
            color: var(--gray);
            margin-bottom: 25px;
        }
        
        .password-input-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .password-input-container input {
            width: 100%;
            padding: 15px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: rgba(245,247,250,0.5);
        }
        
        .password-input-container input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(94,114,228,0.25);
            background: var(--white);
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .login-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        
        .login-error {
            color: var(--accent);
            margin-top: 15px;
            display: none;
            font-size: 0.9rem;
        }
        
        .login-security {
            margin-top: 20px;
            padding: 15px;
            background: rgba(245,247,250,0.5);
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .login-security i {
            color: var(--success);
            margin-right: 8px;
        }
        
        /* Main App Styles */
        #app-container {
            display: flex;
            min-height: 100vh;
            transition: var(--transition);
        }
        
        /* Sidebar Styles */
        #sidebar {
            width: 280px;
            background: var(--white);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: var(--transition);
            transform: translateX(0);
        }
        
        #sidebar.collapsed {
            transform: translateX(-280px);
        }
        
        #sidebar-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            background: var(--gradient-primary);
            color: var(--white);
        }
        
        #sidebar-header h2 {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #sidebar-header h2 i {
            margin-right: 10px;
        }
        
        .nav-menu {
            list-style: none;
            padding: 20px 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .nav-menu li {
            padding: 15px 25px;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            color: var(--dark);
            font-weight: 500;
        }
        
        .nav-menu li:hover {
            background-color: rgba(94,114,228,0.05);
        }
        
        .nav-menu li.active {
            background-color: rgba(94,114,228,0.1);
            border-left-color: var(--primary);
            color: var(--primary);
        }
        
        .nav-menu li i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        #logout-btn {
            margin: 20px;
            background: var(--gradient-secondary);
            border: none;
            color: var(--white);
            padding: 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        
        #logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Content Area */
        #content-wrapper {
            flex-grow: 1;
            margin-left: 280px;
            transition: var(--transition);
        }
        
        #content-wrapper.expanded {
            margin-left: 0;
        }
        
        /* Top Bar */
        #top-bar {
            background: var(--white);
            padding: 15px 25px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 900;
        }
        
        #menu-toggle {
            background: none;
            border: none;
            color: var(--dark);
            font-size: 1.5rem;
            cursor: pointer;
            margin-right: 15px;
            display: none;
        }
        
        #page-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        #top-bar-actions {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }
        
        .top-bar-btn {
            background: var(--gradient-primary);
            border: none;
            color: var(--white);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }
        
        .top-bar-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        /* Main Content */
        #main-content {
            padding: 25px;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card Styles */
        .card {
            background: var(--white);
            border-radius: 0.5rem;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        h1, h2, h3, h4 {
            color: var(--dark);
            margin-bottom: 20px;
        }
        
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.3rem; }
        h4 { font-size: 1.1rem; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 25px;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card h3 {
            color: var(--white);
            margin-bottom: 10px;
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .stat-card h1 {
            color: var(--white);
            font-size: 2.5rem;
            margin: 0;
        }
        
        .stat-card.success {
            background: var(--gradient-success);
        }
        
        .stat-card.info {
            background: var(--gradient-info);
        }
        
        .stat-card.warning {
            background: var(--gradient-warning);
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        thead {
            background-color: var(--light);
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        tr:hover {
            background-color: rgba(94,114,228,0.05);
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(94,114,228,0.25);
        }
        
        /* Button Styles */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
        }
        
        .btn-success {
            background: var(--gradient-success);
            color: var(--white);
        }
        
        .btn-danger {
            background: var(--gradient-secondary);
            color: var(--white);
        }
        
        .btn-warning {
            background: var(--gradient-warning);
            color: var(--white);
        }
        
        .btn-info {
            background: var(--gradient-info);
            color: var(--white);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: var(--border-radius);
            color: var(--white);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .action-btn i {
            margin-right: 5px;
        }
        
        /* Footer */
        .admin-footer {
            text-align: center;
            padding: 20px 15px;
            margin-top: 30px;
            font-size: 0.8rem;
            color: var(--gray);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        
        .developer-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .developer-link:hover {
            text-decoration: underline;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            #sidebar {
                transform: translateX(-280px);
            }
            
            #sidebar.show {
                transform: translateX(0);
            }
            
            #content-wrapper {
                margin-left: 0;
            }
            
            #menu-toggle {
                display: block;
            }
            
            #overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 999;
                display: none;
            }
            
            #overlay.show {
                display: block;
            }
        }
        
        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
        }
        
        /* Additional Styles */
        .badge {
            display: inline-block;
            padding: 0.25em 0.4em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }
        
        .badge-primary {
            color: var(--white);
            background-color: var(--primary);
        }
        
        .badge-success {
            color: var(--white);
            background-color: var(--success);
        }
        
        .badge-danger {
            color: var(--white);
            background-color: var(--accent);
        }
        
        .badge-warning {
            color: var(--white);
            background-color: var(--warning);
        }
        
        .badge-info {
            color: var(--white);
            background-color: var(--info);
        }
        
        .progress {
            height: 1rem;
            background-color: var(--light);
            border-radius: 0.25rem;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.6s ease;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .task-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            background: var(--white);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        
        .task-container:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            color: var(--white);
            font-size: 1.5rem;
        }
        
        .task-info {
            flex-grow: 1;
        }
        
        .task-info h3 {
            margin: 0 0 5px;
            font-size: 1.1rem;
        }
        
        .task-info p {
            margin: 0;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .device-info {
            background: var(--light);
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        
        .device-users {
            margin-top: 10px;
        }
        
        .device-user {
            display: inline-block;
            background: var(--primary);
            color: var(--white);
            padding: 3px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.8rem;
        }
        
        .currency-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--info);
            color: var(--white);
            margin-left: 5px;
        }
        
        .user-status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .status-active {
            background: var(--success);
            color: var(--white);
        }
        
        .status-blocked {
            background: var(--accent);
            color: var(--white);
        }
        
        .ads-today-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--info);
            color: var(--white);
            margin-left: 5px;
        }
        
        .task-completion-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .task-stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow-sm);
            text-align: center;
            transition: var(--transition);
        }
        
        .task-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .task-stat-card h4 {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 8px;
        }
        
        .task-stat-card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }
        
        .logout-timer {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gradient-warning);
            color: var(--white);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1001;
            box-shadow: var(--shadow);
            display: none;
        }
        
        .broadcast-badge {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--accent);
            color: var(--white);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 1001;
            box-shadow: var(--shadow);
        }
        
        .currency-rates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .currency-rate-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 15px;
            border: 1px solid rgba(0,0,0,0.05);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        
        .currency-rate-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .currency-flag {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .currency-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .currency-rate {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .withdraw-method-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        
        .task-settings-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .task-settings-group .form-group {
            margin-bottom: 0;
        }
        
        /* Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s;
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div id="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h2>Admin Panel</h2>
            <p>Please enter your password to continue</p>
            <div class="password-input-container">
                <input type="password" id="login-password" placeholder="Enter Admin Password">
                <button type="button" class="password-toggle" id="password-toggle">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <button class="login-btn" id="login-submit">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <p id="login-error" class="login-error">
                <i class="fas fa-exclamation-triangle"></i> Invalid password!
            </p>
            <div class="login-security">
                <p><i class="fas fa-lock"></i> Secure Admin Access</p>
                <p style="font-size: 0.75rem; margin-top: 5px;">Unauthorized access is prohibited</p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" style="display: none;">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div id="sidebar-header">
                <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
            </div>
            <ul class="nav-menu">
                <li data-page="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                <li data-page="users"><i class="fas fa-users"></i> Users</li>
                <li data-page="devices"><i class="fas fa-mobile-alt"></i> Device Management</li>
                <li data-page="withdrawals"><i class="fas fa-wallet"></i> Pending Withdrawals</li>
                <li data-page="history"><i class="fas fa-history"></i> Withdrawal History</li>
                <li data-page="tasks"><i class="fas fa-tasks"></i> Tasks & Links</li>
                <li data-page="settings"><i class="fas fa-cog"></i> App Settings</li>
                <li data-page="broadcast"><i class="fas fa-bullhorn"></i> Broadcast</li>
            </ul>
            <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </aside>
        
        <!-- Overlay for mobile -->
        <div id="overlay"></div>

        <!-- Content Wrapper -->
        <div id="content-wrapper">
            <!-- Top Bar -->
            <header id="top-bar">
                <button id="menu-toggle"><i class="fas fa-bars"></i></button>
                <h1 id="page-title">Dashboard</h1>
                <div id="top-bar-actions">
                    <button class="top-bar-btn" id="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
            </header>
            
            <!-- Main Content -->
            <main id="main-content"></main>
        </div>
    </div>

    <!-- Task Edit Modal -->
    <div id="task-edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Task</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="form-group"><input id="edit-task-name" placeholder="Task Name"></div>
            <div class="form-group"><input id="edit-task-url" placeholder="URL"></div>
            <div class="form-group"><input id="edit-task-reward" type="number" step="any" placeholder="Reward Amount (BDT)"></div>
            <div class="form-group"><input id="edit-task-icon" placeholder="Image Icon URL"></div>
            
            <div class="task-settings-group">
                <div class="form-group">
                    <label>Daily Task Limit</label>
                    <input id="edit-task-daily-limit" type="number" placeholder="0 for no limit" value="0">
                </div>
                <div class="form-group">
                    <label>Ads Before Break</label>
                    <input id="edit-task-ads-break" type="number" placeholder="0 for no break" value="0">
                </div>
                <div class="form-group">
                    <label>Break Duration (Minutes)</label>
                    <input id="edit-task-break-duration" type="number" placeholder="Break time in minutes" value="0">
                </div>
                <div class="form-group">
                    <label>Task Delay (Seconds)</label>
                    <input id="edit-task-delay" type="number" placeholder="Delay before reward" value="5">
                </div>
            </div>
            
            <button class="btn btn-primary btn-block" id="save-task-changes">Save Changes</button>
        </div>
    </div>

    <!-- Auto Logout Timer -->
    <div class="logout-timer" id="logout-timer">
        Auto logout in: <span id="logout-time">30:00</span>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyCudVtd11MFb7rqn-jaJQMh6IBwqYLIhqQ",
            authDomain: "earn-master-bot-71086.firebaseapp.com",
            databaseURL: "https://earn-master-bot-71086-default-rtdb.firebaseio.com",
            projectId: "earn-master-bot-71086",
            storageBucket: "earn-master-bot-71086.firebasestorage.app",
            messagingSenderId: "1077961104769",
            appId: "1:1077961104769:web:4be297d789087df0709c80"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const mainContent = document.getElementById('main-content');
        const pageTitle = document.getElementById('page-title');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const refreshBtn = document.getElementById('refresh-btn');
        
        // Login elements
        const loginContainer = document.getElementById('login-container');
        const loginPassword = document.getElementById('login-password');
        const loginSubmit = document.getElementById('login-submit');
        const loginError = document.getElementById('login-error');
        const passwordToggle = document.getElementById('password-toggle');
        const logoutTimer = document.getElementById('logout-timer');
        const logoutTime = document.getElementById('logout-time');

        // Task Edit Modal elements
        const taskEditModal = document.getElementById('task-edit-modal');
        const modalClose = document.querySelector('.modal-close');
        const saveTaskChangesBtn = document.getElementById('save-task-changes');

        // Current active page
        let currentPage = 'dashboard';
        let adminPassword = '';
        let loginAttempts = 0;
        const maxLoginAttempts = 5;
        let loginLockedUntil = 0;
        let autoLogoutTimer = null;
        let autoLogoutTime = 30 * 60; // 30 minutes default
        let currentEditingTaskKey = null;

        // Password toggle functionality
        passwordToggle.addEventListener('click', () => {
            const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            loginPassword.setAttribute('type', type);
            passwordToggle.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        // Enhanced load admin password and check authentication
        const initAdminPanel = async () => {
            try {
                const configSnapshot = await db.ref('config').once('value');
                const config = configSnapshot.val() || {};
                adminPassword = config.adminPassword || 'admin123'; // Default password
                autoLogoutTime = config.autoLogoutTime || 30; // minutes
                
                // Check if login is temporarily locked
                const lockTime = localStorage.getItem('adminLoginLockedUntil');
                if (lockTime && Date.now() < parseInt(lockTime)) {
                    loginLockedUntil = parseInt(lockTime);
                    showLoginLocked();
                    return;
                }
                
                // Check if user is already logged in
                const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
                const loginTime = localStorage.getItem('adminLoginTime');
                const currentTime = Date.now();
                
                if (isLoggedIn && loginTime) {
                    const timeSinceLogin = (currentTime - parseInt(loginTime)) / 1000 / 60; // minutes
                    if (timeSinceLogin < autoLogoutTime) {
                        showAdminPanel();
                        startAutoLogoutTimer(autoLogoutTime * 60 - timeSinceLogin * 60);
                    } else {
                        localStorage.removeItem('adminLoggedIn');
                        localStorage.removeItem('adminLoginTime');
                        showLogin();
                    }
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Error loading admin configuration:', error);
                adminPassword = 'admin123'; // Fallback default password
                showLogin();
            }
        };

        const showLogin = () => {
            loginContainer.style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            logoutTimer.style.display = 'none';
            
            // Reset login attempts if lock time has passed
            if (loginLockedUntil && Date.now() > loginLockedUntil) {
                loginAttempts = 0;
                loginLockedUntil = 0;
                localStorage.removeItem('adminLoginLockedUntil');
            }
            
            // Focus on password input
            setTimeout(() => {
                loginPassword.focus();
            }, 100);
        };

        const showLoginLocked = () => {
            const remainingTime = Math.ceil((loginLockedUntil - Date.now()) / 1000 / 60);
            loginContainer.innerHTML = `
                <div class="login-box">
                    <div class="login-logo">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h2>Access Temporarily Locked</h2>
                    <p>Too many failed login attempts. Please try again in ${remainingTime} minutes.</p>
                    <div class="login-security">
                        <p><i class="fas fa-clock"></i> Security Lock Active</p>
                    </div>
                </div>
            `;
        };

        const showAdminPanel = () => {
            loginContainer.style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            // Reset login attempts on successful login
            loginAttempts = 0;
            localStorage.removeItem('adminLoginAttempts');
            localStorage.removeItem('adminLoginLockedUntil');
            
            // Store login time
            localStorage.setItem('adminLoginTime', Date.now().toString());
            
            // Start auto logout timer
            startAutoLogoutTimer(autoLogoutTime * 60);
            
            // Initialize admin panel
            setupNavigation(); 
            setupMobileMenu(); 
            setupTopBarButtons();
            setupModalListeners();
            renderDashboard();
        };

        const setupModalListeners = () => {
            // Close modal when clicking X or outside
            modalClose.addEventListener('click', () => {
                taskEditModal.classList.remove('show');
            });
            
            taskEditModal.addEventListener('click', (e) => {
                if (e.target === taskEditModal) {
                    taskEditModal.classList.remove('show');
                }
            });
            
            // Save task changes
            saveTaskChangesBtn.addEventListener('click', saveTaskChanges);
        };

        const startAutoLogoutTimer = (seconds) => {
            if (autoLogoutTimer) {
                clearInterval(autoLogoutTimer);
            }
            
            let timeLeft = seconds;
            updateLogoutTimerDisplay(timeLeft);
            logoutTimer.style.display = 'block';
            
            autoLogoutTimer = setInterval(() => {
                timeLeft--;
                updateLogoutTimerDisplay(timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(autoLogoutTimer);
                    autoLogout();
                }
            }, 1000);
        };

        const updateLogoutTimerDisplay = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            logoutTime.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        };

        const autoLogout = () => {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminLoginTime');
            showLogin();
            alert('Session expired due to inactivity. Please login again.');
        };

        const resetAutoLogoutTimer = () => {
            startAutoLogoutTimer(autoLogoutTime * 60);
        };

        // Enhanced Login functionality
        loginSubmit.addEventListener('click', () => {
            // Check if login is locked
            if (loginLockedUntil && Date.now() < loginLockedUntil) {
                showLoginLocked();
                return;
            }
            
            const enteredPassword = loginPassword.value.trim();
            if (!enteredPassword) {
                showLoginError('Please enter password');
                return;
            }
            
            if (enteredPassword === adminPassword) {
                // Successful login
                localStorage.setItem('adminLoggedIn', 'true');
                showAdminPanel();
            } else {
                loginAttempts++;
                localStorage.setItem('adminLoginAttempts', loginAttempts.toString());
                
                if (loginAttempts >= maxLoginAttempts) {
                    // Lock login for 30 minutes
                    loginLockedUntil = Date.now() + (30 * 60 * 1000);
                    localStorage.setItem('adminLoginLockedUntil', loginLockedUntil.toString());
                    showLoginLocked();
                } else {
                    const remainingAttempts = maxLoginAttempts - loginAttempts;
                    showLoginError(`Invalid password! ${remainingAttempts} attempts remaining`);
                }
            }
        });

        // Allow pressing Enter to login
        loginPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginSubmit.click();
            }
        });

        const showLoginError = (message) => {
            loginError.textContent = message;
            loginError.style.display = 'block';
            loginPassword.value = '';
            loginPassword.focus();
            
            // Shake animation for error
            loginPassword.classList.add('shake');
            setTimeout(() => {
                loginPassword.classList.remove('shake');
            }, 500);
        };
        
        const renderDashboard = async () => {
            const usersSnap = await db.ref('users').once('value');
            const withdrawalsSnap = await db.ref('withdrawals/pending').once('value');
            const devicesSnap = await db.ref('deviceUsage').once('value');
            const tasksSnap = await db.ref('config/tasks').once('value');
            const blockedReferralsSnap = await db.ref('blockedReferrals').once('value');
            
            let multiDeviceCount = 0;
            devicesSnap.forEach(device => {
                const users = device.val().users;
                if (users && Object.keys(users).length > 1) {
                    multiDeviceCount++;
                }
            });

            // Calculate today's total ads watched
            const today = new Date().toISOString().slice(0, 10);
            let todayAdsWatched = 0;
            let todayTaskCompletions = 0;
            
            usersSnap.forEach(user => {
                const userData = user.val();
                if (userData.lastAdWatchDate === today) {
                    todayAdsWatched += userData.dailyAdCount || 0;
                }
                
                // Count task completions for today
                if (userData.taskCompletions) {
                    const taskCompletions = userData.taskCompletions[today] || {};
                    Object.values(taskCompletions).forEach(count => {
                        todayTaskCompletions += count || 0;
                    });
                }
            });

            // Calculate task completion stats
            const taskStats = {};
            if (tasksSnap.exists()) {
                tasksSnap.forEach(taskSnap => {
                    const task = taskSnap.val();
                    taskStats[taskSnap.key] = {
                        name: task.name,
                        completions: 0
                    };
                });
                
                // Count completions for each task
                usersSnap.forEach(user => {
                    const userData = user.val();
                    if (userData.taskCompletions) {
                        Object.keys(userData.taskCompletions).forEach(date => {
                            if (date === today) {
                                Object.keys(userData.taskCompletions[date]).forEach(taskId => {
                                    if (taskStats[taskId]) {
                                        taskStats[taskId].completions += userData.taskCompletions[date][taskId] || 0;
                                    }
                                });
                            }
                        });
                    }
                });
            }

            mainContent.innerHTML = `<div id="dashboard" class="page active">
                <h2>Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <h1>${usersSnap.numChildren()}</h1>
                    </div>
                    <div class="stat-card success">
                        <h3>Pending Withdrawals</h3>
                        <h1>${withdrawalsSnap.numChildren()}</h1>
                    </div>
                    <div class="stat-card info">
                        <h3>Multi-Device Users</h3>
                        <h1>${multiDeviceCount}</h1>
                        <small>Devices with multiple accounts</small>
                    </div>
                    <div class="stat-card warning">
                        <h3>Blocked Referrals</h3>
                        <h1>${blockedReferralsSnap.numChildren()}</h1>
                        <small>Same device referral attempts</small>
                    </div>
                    <div class="stat-card">
                        <h3>Today's Ads Watched</h3>
                        <h1>${todayAdsWatched}</h1>
                        <small>Total ads watched today</small>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Today's Task Completions</h3>
                    <div class="task-completion-stats">
                        <div class="task-stat-card">
                            <h4>Total Task Completions</h4>
                            <p>${todayTaskCompletions}</p>
                        </div>
                        ${Object.keys(taskStats).map(taskId => `
                            <div class="task-stat-card">
                                <h4>${taskStats[taskId].name}</h4>
                                <p>${taskStats[taskId].completions}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="card">
                    <h3>Quick Actions</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="window.adminActions.renderWithdrawals()"><i class="fas fa-wallet"></i> Manage Withdrawals</button>
                        <button class="btn btn-success" onclick="window.adminActions.renderUsers()"><i class="fas fa-users"></i> View Users</button>
                        <button class="btn btn-info" onclick="window.adminActions.renderSettings()"><i class="fas fa-cog"></i> App Settings</button>
                        <button class="btn btn-warning" onclick="window.adminActions.renderDevices()"><i class="fas fa-mobile-alt"></i> Device Management</button>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="admin-footer">
                    Developed by <span class="developer-link" onclick="window.open('https://t.me/sojib4280', '_blank')">Sojib</span>
                </div>
            </div>`;
        };
        
        const renderUsers = async () => {
            mainContent.innerHTML = '<div class="card"><h3>Loading Users...</h3></div>';
            const snap = await db.ref('users').orderByChild('firstName').once('value'); 
            let tableContent = '';
            
            const today = new Date().toISOString().slice(0, 10);
            
            snap.forEach(child => {
                const user = child.val();
                const isBlocked = user.isBlocked || false;
                const statusBadge = isBlocked ? 
                    '<span class="user-status-badge status-blocked">Blocked</span>' : 
                    '<span class="user-status-badge status-active">Active</span>';
                
                // Check if user watched ads today
                const todayAds = (user.lastAdWatchDate === today) ? (user.dailyAdCount || 0) : 0;
                const adsTodayBadge = todayAds > 0 ? `<span class="ads-today-badge">${todayAds} ads today</span>` : '';
                
                // Check task completions for today
                let todayTasks = 0;
                if (user.taskCompletions && user.taskCompletions[today]) {
                    Object.values(user.taskCompletions[today]).forEach(count => {
                        todayTasks += count || 0;
                    });
                }
                const tasksTodayBadge = todayTasks > 0 ? `<span class="ads-today-badge" style="background: var(--success);">${todayTasks} tasks today</span>` : '';
                
                // Show user's selected currency
                const userCurrency = user.currency || 'BDT';
                const currencyBadge = `<span class="ads-today-badge" style="background: var(--warning);">${userCurrency}</span>`;
                
                tableContent += `<tr>
                    <td>
                        ${user.firstName || ''} ${user.lastName || ''}
                        ${statusBadge}
                        ${adsTodayBadge}
                        ${tasksTodayBadge}
                        ${currencyBadge}
                        <br><small>${user.id}</small>
                        ${user.deviceId ? `<br><small style="color:#666;">Device: ${user.deviceId.substring(0, 8)}...</small>` : ''}
                        <br><small>Joined: ${new Date(user.joinDate || Date.now()).toLocaleDateString()}</small>
                    </td>
                    <td>
                        <strong>${(user.balance || 0).toFixed(3)} TK</strong>
                        <br><small>Total Earned: ${(user.totalEarned || 0).toFixed(3)} TK</small>
                        <br><small>Lifetime Ads: ${user.lifetimeAdCount || 0}</small>
                        <br><small>Tasks Completed: ${Object.keys(user.completedTasks || {}).length}</small>
                    </td>
                    <td>${user.referrals || 0}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-primary" onclick="window.adminActions.editUserBalance('${user.id}', '${user.firstName}')">Edit Balance</button>
                            <button class="action-btn ${isBlocked ? 'btn-success' : 'btn-danger'}" onclick="window.adminActions.toggleUserBlock('${user.id}', ${isBlocked})">
                                ${isBlocked ? 'Unblock' : 'Block'}
                            </button>
                            <button class="action-btn btn-info" onclick="window.adminActions.sendPersonalMessage('${user.id}', '${user.firstName}')">Send Message</button>
                        </div>
                    </td>
                </tr>`;
            });
            
            mainContent.innerHTML = `<div id="users" class="page active">
                <h2>All Users</h2>
                <div class="card">
                    <div style="margin-bottom: 15px;">
                        <p><strong>Today's Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><small>Shows how many ads and tasks each user completed today</small></p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>User Information</th>
                                <th>Balance & Stats</th>
                                <th>Referrals</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>${tableContent}</tbody>
                    </table>
                </div>
                
                <!-- Footer -->
                <div class="admin-footer">
                    Developed by <span class="developer-link" onclick="window.open('https://t.me/sojib4280', '_blank')">Sojib</span>
                </div>
            </div>`;
        };

        // Device Management Page
        const renderDevices = async () => {
            mainContent.innerHTML = '<div class="card"><h3>Loading Device Information...</h3></div>';
            const devicesSnap = await db.ref('deviceUsage').once('value');
            const blockedSnap = await db.ref('blockedReferrals').once('value');
            
            let devicesContent = '';
            let deviceCount = 0;
            let multiAccountDevices = 0;

            devicesSnap.forEach(deviceSnap => {
                const deviceId = deviceSnap.key;
                const deviceData = deviceSnap.val();
                const users = deviceData.users || {};
                const userCount = Object.keys(users).length;
                
                if (userCount > 1) {
                    multiAccountDevices++;
                }

                deviceCount++;
                
                let usersList = '';
                Object.keys(users).forEach(userId => {
                    usersList += `<span class="device-user">${userId.substring(0, 8)}...</span>`;
                });

                devicesContent += `
                    <div class="device-info">
                        <strong>Device ID:</strong> ${deviceId}<br>
                        <strong>Users on this device:</strong> ${userCount}<br>
                        <strong>Last Used:</strong> ${deviceData.lastUsed ? new Date(deviceData.lastUsed).toLocaleString() : 'Unknown'}<br>
                        <div class="device-users">${usersList}</div>
                    </div>
                `;
            });

            let blockedContent = '';
            blockedSnap.forEach(blockedSnap => {
                const blockedData = blockedSnap.val();
                blockedContent += `
                    <div class="device-info" style="background:#ffe6e6; border-left-color: var(--accent);">
                        <strong>Reason:</strong> ${blockedData.reason || 'Unknown'}<br>
                        <strong>Referrer:</strong> ${blockedData.referrerId || 'N/A'}<br>
                        <strong>User:</strong> ${blockedData.earningUserId || blockedData.newUserId || 'N/A'}<br>
                        <strong>Device:</strong> ${blockedData.deviceId || 'N/A'}<br>
                        <strong>Time:</strong> ${new Date(blockedData.timestamp).toLocaleString()}<br>
                        ${blockedData.amount ? `<strong>Amount:</strong> ${blockedData.amount.toFixed(3)} TK<br>` : ''}
                    </div>
                `;
            });

            mainContent.innerHTML = `
                <div id="devices" class="page active">
                    <h2>Device Management</h2>
                    
                    <div class="card">
                        <h3>Device Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Total Devices</h3>
                                <h1>${deviceCount}</h1>
                            </div>
                            <div class="stat-card info">
                                <h3>Multi-Account Devices</h3>
                                <h1>${multiAccountDevices}</h1>
                            </div>
                            <div class="stat-card warning">
                                <h3>Blocked Referrals</h3>
                                <h1>${blockedSnap.numChildren()}</h1>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>All Devices</h3>
                        ${devicesContent || '<p>No device data found.</p>'}
                    </div>

                    <div class="card">
                        <h3>Blocked Referral Attempts</h3>
                        ${blockedContent || '<p>No blocked referrals found.</p>'}
                    </div>
                    
                    <!-- Footer -->
                    <div class="admin-footer">
                        Developed by <span class="developer-link" onclick="window.open('https://t.me/sojib4280', '_blank')">Sojib</span>
                    </div>
                </div>
            `;
        };
        
        // Updated renderWithdrawals to show original currency
        const renderWithdrawals = async () => {
            mainContent.innerHTML = '<div class="card"><h3>Loading Requests...</h3></div>';
            const snap = await db.ref('withdrawals/pending').orderByChild('timestamp').once('value'); 
            let tableContent = '';
            let requests = [];
            snap.forEach(child => { requests.push(child.val()); });
            requests.reverse(); // Show newest first
            
            // Load exchange rates to convert currencies to BDT
            const configSnap = await db.ref('config').once('value');
            const config = configSnap.val() || {};
            const exchangeRates = config.exchangeRates || { USD: 0, INR: 0, PKR: 0 };
            
            requests.forEach(req => {
                // Get original currency and amount
                const originalCurrency = req.currency || 'BDT';
                const originalAmount = req.amount || 0;
                
                // Also get BDT equivalent if available
                const bdtAmount = req.amountInBDT || 0;
                
                // Display original amount and currency
                let displayAmount = originalAmount.toFixed(3);
                let displayCurrency = getCurrencySymbol(originalCurrency);
                
                // Also show BDT equivalent if different
                let bdtEquivalent = '';
                if (originalCurrency !== 'BDT' && bdtAmount > 0) {
                    bdtEquivalent = `<br><small> ${bdtAmount.toFixed(3)} BDT</small>`;
                }
                
                tableContent += `<tr>
                    <td>${req.userName}<br><small>${new Date(req.timestamp).toLocaleString()}</small></td>
                    <td>
                        <b>${displayAmount} ${displayCurrency}</b>
                        ${bdtEquivalent}
                        <br><small>${req.method} | ${req.account}</small>
                        <div class="currency-badge">${originalCurrency}</div>
                    </td>
                    <td><div class="action-buttons"><button class="action-btn btn-success" onclick="window.adminActions.handleWithdrawal('${req.id}', 'approve')">Approve</button><button class="action-btn btn-danger" onclick="window.adminActions.handleWithdrawal('${req.id}', 'reject')">Reject</button></div></td>
                </tr>`;
            });
            mainContent.innerHTML = `<div id="withdrawals" class="page active"><h2>Pending Withdrawals</h2><div class="card"><table><thead><tr><th>User & Date</th><th>Amount & Details</th><th>Actions</th></tr></thead><tbody>${tableContent || '<tr><td colspan=3>No pending requests</td></tr>'}</tbody></table></div>
                
                <!-- Footer -->
                <div class="admin-footer">
                    Developed by <span class="developer-link" onclick="window.open('https://t.me/sojib4280', '_blank')">Sojib</span>
                </div>
            </div>`;
        };
        
        // Updated renderWithdrawalHistory to show original currency
        const renderWithdrawalHistory = async () => {
            mainContent.innerHTML = '<div class="card"><h3>Loading History...</h3></div>';
            const completedSnap = await db.ref('withdrawals/completed').orderByChild('timestamp').limitToLast(100).once('value');
            const rejectedSnap = await db.ref('withdrawals/rejected').orderByChild('timestamp').limitToLast(100).once('value');
            let completedRows = '', rejectedRows = '';
            
            // Load exchange rates to convert currencies to BDT
            const configSnap = await db.ref('config').once('value');
            const config = configSnap.val() || {};
            const exchangeRates = config.exchangeRates || { USD: 0, INR: 0, PKR: 0 };
            
            let completed = [];
            completedSnap.forEach(child => { completed.push(child.val()); });
            completed.reverse();
            completed.forEach(req => { 
                // Get original currency and amount
                const originalCurrency = req.currency || 'BDT';
                const originalAmount = req.amount || 0;
                
                // Also get BDT equivalent if available
                const bdtAmount = req.amountInBDT || 0;
                
                // Display original amount and currency
                let displayAmount = originalAmount.toFixed(3);
                let displayCurrency = getCurrencySymbol(originalCurrency);
                
                // Also show BDT equivalent if different
                let bdtEquivalent = '';
                if (originalCurrency !== 'BDT' && bdtAmount > 0) {
                    bdtEquivalent = `<br><small> ${bdtAmount.toFixed(3)} BDT</small>`;
                }
                
                completedRows += `<tr>
                    <td>${req.userName}</td>
                    <td>
                        <b>${displayAmount} ${displayCurrency}</b>
                        ${bdtEquivalent}
                        <div class="currency-badge">${originalCurrency}</div>
                    </td>
                    <td>${new Date(req.timestamp).toLocaleDateString()}</td>
                    <td>Completed</td>
                </tr>`; 
            });

            let rejected = [];
            rejectedSnap.forEach(child => { rejected.push(child.val()); });
            rejected.reverse();
            rejected.forEach(req => { 
                // Get original currency and amount
                const originalCurrency = req.currency || 'BDT';
                const originalAmount = req.amount || 0;
                
                // Also get BDT equivalent if available
                const bdtAmount = req.amountInBDT || 0;
                
                // Display original amount and currency
                let displayAmount = originalAmount.toFixed(3);
                let displayCurrency = getCurrencySymbol(originalCurrency);
                
                // Also show BDT equivalent if different
                let bdtEquivalent = '';
                if (originalCurrency !== 'BDT' && bdtAmount > 0) {
                    bdtEquivalent = `<br><small> ${bdtAmount.toFixed(3)} BDT</small>`;
                }
                
                rejectedRows += `<tr>
                    <td>${req.userName}</td>
                    <td>
                        <b>${displayAmount} ${displayCurrency}</b>
                        ${bdtEquivalent}
                        <div class="currency-badge">${originalCurrency}</div>
                    </td>
                    <td>${new Date(req.timestamp).toLocaleDateString()}</td>
                    <td>Rejected</td>
                </tr>`; 
            });
            
            mainContent.innerHTML = `
                <div id="history" class="page active">
                    <h2>Withdrawal History</h2>
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button class="tab-btn active" data-tab="completed">Completed</button>
                            <button class="tab-btn" data-tab="rejected">Rejected</button>
                        </div>
                        <div class="tab-content">
                            <div id="completed-tab" class="tab-pane active">
                                <div class="card">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>${completedRows || '<tr><td colspan="4">No completed requests.</td></tr>'}</tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="rejected-tab" class="tab-pane" style="display: none;">
                                <div class="card">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>${rejectedRows || '<tr><td colspan="4">No rejected requests.</td></tr>'}</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="admin-footer">
                        Developed by <span class="developer-link" onclick="window.open('https://t.me/sojib4280', '_blank')">Sojib</span>
                    </div>
                </div>`;
                
            // Add tab switching functionality
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
                    
                    this.classList.add('active');
                    document.getElementById(`${this.dataset.tab}-tab`).style.display = 'block';
                });
            });
        };

        const renderTasks = async () => {
            const snap = await db.ref('config/tasks').once('value');
            let tasks = [];
            snap.forEach(child => { tasks.push({ key: child.key, ...child.val() }); });
            tasks.reverse();
            
            let tasksList = '';
            tasks.forEach(task => {
                tasksList += `
                    <div class="task-container">
                        <div class="task-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="task-info">
                            <h3>${task.name}</h3>
                            <p>Reward: ${task.reward.toFixed(3)} BDT | URL: ${task.url}</p>
                            <p>Daily Limit: ${task.dailyLimit || 'No limit'} | Ads Before Break: ${task.adsPerBreak || 'No break'} | Break Time: ${task.breakDuration || 0} min</p>
                            <p>Task Delay: ${task.taskDelay || 5} seconds</p>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn btn-warning" onclick="window.adminActions.editTask('${task.key}')">Edit</button>
                            <button class="action-btn btn-danger" onclick="window.adminActions.deleteDynamicItem('tasks', '${task.key}')">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            mainContent.innerHTML = `<div id="tasks" class="page active"><h2>Manage Tasks & Links</h2>
                <div class="card">
                    <h3>Current Tasks</h3>
                    ${tasksList || '<p>No tasks found.</p>'}
                </div>
                <div class="card"><h3>Add New Task</h3>
                    <div class="form-group"><input id="task-name" placeholder="Task Name (e.g., Join Telegram)"></div>
                    <div class="form-group"><input id="task-url" placeholder="URL"></div>
                    <div class="form-group"><input id="task-reward" type="number" step="any" placeholder="Reward Amount (BDT)"></div>
                    <div class="form-group"><input id="task-icon" placeholder="Image Icon URL"></div>
                    
                    <div class="task-settings-group">
                        <div class="form-group">
                            <label>Daily Task Limit</label>
                            <input id="task-daily-limit" type="number" placeholder="0 for no limit" value="0">
                        </div>
                        <div class="form-group">
                            <label>Ads Before Break</label>
                            <input id="task-ads-break" type="number" placeholder="0 for no break" value="0">
                        </div>
                        <div class="form-group">
                            <label>Break Duration (Minutes)</label>
                            <input id="task-break-duration" type="number" placeholder="Break time in minutes" value="0">
                        </div>
                        <div class="form-group">
                            <label>Task Delay (Seconds)</label>
                            <input id="task-delay" type="number" placeholder="Delay before reward" value="5">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary btn-block" onclick="window.adminActions.addTask()">Add Task</button>
                </div>
                <div class="card" id="links-list"><h3>Loading links...</h3></div>
                <div class="card"><h3>Add New Link/Button</h3>
                    <div class="form-group"><input id="link-name" placeholder="Button Name (e.g., Official Channel)"></div>
                    <div class="form-group"><input id="link-url" placeholder="URL"></div>
                    <div class="form-group"><input id="link-icon" placeholder="Image Icon URL"></div>
                    <button class="btn btn-primary btn-block" onclick="window.adminActions.addLink()">Add Link</button>
                </div>
                
                <!-- Footer -->
                <div class="admin-footer">
                    Developed by <span class="developer-link" onclick="window.open('https://t.me/sojib4280', '_blank')">Sojib</span>
                </div>
            </div>`;
            loadDynamicContent('links');
        };

        const renderSettings = async () => {
            const snap = await db.ref('config').once('value'); 
            const config = snap.val() || {};
            mainContent.innerHTML = `<div id="settings" class="page active"><h2>App Settings</h2>
                <div class="card">
                    <h3>Basic Settings</h3>
                    <div class="form-group"><label>Bot Username (without @)</label><input type="text" id="botUsername" value="${config.botUsername || ''}"></div>
                    <div class="form-group"><label>Welcome Message</label><textarea id="welcomeMessage" rows="3">${config.welcomeMessage || ''}</textarea></div>
                    
                    <h3>Ad Settings</h3>
                    <div class="checkbox-container">
                        <input type="checkbox" id="monetagEnabled" ${config.monetagEnabled !== false ? 'checked' : ''}>
                        <label for="monetagEnabled">Enable Monetag Ads</label>
                    </div>
                    <div class="form-group"><label>Monetag Ad Zone ID</label><input type="number" id="adZoneId" value="${config.adZoneId || ''}"></div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="adexoraEnabled" ${config.adexoraEnabled !== false ? 'checked' : ''}>
                        <label for="adexoraEnabled">Enable Adexora Ads</label>
                    </div>
                    <div class="form-group"><label>Adexora Ad ID</label><input type="number" id="adexoraId" value="${config.adexoraId || ''}" placeholder="Enter Adexora Ad ID"></div>
                    
                    <h3>Earning Settings</h3>
                    <div class="form-group"><label>Value per Ad (BDT)</label><input type="number" step="any" id="adValue" value="${config.adValue || 0}"></div>
                    <div class="form-group"><label>Daily Ad Limit</label><input type="number" id="dailyAdLimit" value="${config.dailyAdLimit || 0}"></div>
                    <div class="form-group"><label>Ads Before Break</label><input type="number" id="adsPerBreak" value="${config.adsPerBreak || 0}"></div>
                    <div class="form-group"><label>Break Duration (Minutes)</label><input type="number" id="breakDuration" value="${config.breakDuration || 0}"></div>
                    
                    <h3>Currency Exchange Rates</h3>
                    <div class="currency-rates-grid">
                        <div class="currency-rate-card">
                            <div class="currency-flag"></div>
                            <div class="currency-name">Bangladeshi Taka (BDT)</div>
                            <div class="currency-rate">1 BDT = 1 BDT</div>
                        </div>
                        <div class="currency-rate-card">
                            <div class="currency-flag"></div>
                            <div class="currency-name">US Dollar (USD)</div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="number" step="any" id="usdRate" value="${config.exchangeRates?.USD || 0}" placeholder="1 USD = ? BDT">
                            </div>
                        </div>
                        <div class="currency-rate-card">
                            <div class="currency-flag"></div>
                            <div class="currency-name">Indian Rupee (INR)</div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="number" step="any" id="inrRate" value="${config.exchangeRates?.INR || 0}" placeholder="1 INR = ? BDT">
                            </div>
                        </div>
                        <div class="currency-rate-card">
                            <div class="currency-flag"></div>
                            <div class="currency-name">Pakistani Rupee (PKR)</div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="number" step="any" id="pkrRate" value="${config.exchangeRates?.PKR || 0}" placeholder="1 PKR = ? BDT">
                            </div>
                        </div>
                    </div>
                    <small style="display: block; text-align: center; color: var(--gray); margin-top: 10px;">
                        Enter how many BDT equals 1 unit of each currency
                    </small>
                    
                    <h3>Referral System Settings</h3>
                    <div class="checkbox-container">
                        <input type="checkbox" id="referralSystemEnabled" ${config.referralSystemEnabled !== false ? 'checked' : ''}>
                        <label for="referralSystemEnabled">Enable Referral System</label>
                    </div>
                    <div class="form-group"><label>Referral Commission Percentage</label><input type="number" step="any" id="referralPercent" value="${config.referralPercent || 10}"></div>
                    <div class="form-group"><label>Referral Bonus (BDT)</label><input type="number" step="any" id="referralBonus" value="${config.referralBonus || 0}"></div>
                    
                    <h3>Wallet Transfer Settings</h3>
                    <div class="form-group">
                        <label>Minimum Balance for Transfer (BDT)</label>
                        <input type="number" step="any" id="minBalanceForTransfer" value="${config.minBalanceForTransfer || 100}" placeholder="Minimum balance to move to main wallet">
                        <small>Users need at least this amount in earning wallet to transfer to main balance</small>
                    </div>
                    
                    <h3>Admin Security Settings</h3>
                    <div class="form-group">
                        <label>Change Admin Password</label>
                        <input type="password" id="oldPassword" placeholder="Enter Current Password">
                        <input type="password" id="newPassword" placeholder="Enter New Password" style="margin-top: 10px;">
                        <input type="password" id="confirmPassword" placeholder="Confirm New Password" style="margin-top: 10px;">
                        <button class="btn btn-warning" onclick="window.adminActions.changePassword()" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Auto Logout Time (Minutes)</label>
                        <input type="number" id="autoLogoutTime" value="${config.autoLogoutTime || 30}" placeholder="Auto logout after minutes">
                        <small>Set to 0 to disable auto logout</small>
                    </div>
                    
                    <h3>Withdrawal Settings</h3>
                    <div class="form-group"><label>Minimum Referrals for Withdraw</label><input type="number" id="minimumWithdrawReferrals" value="${config.minimumWithdrawReferrals || 0}"></div>
                    <div id="withdraw-methods-container"></div>
                    <button class="btn btn-primary" onclick="window.adminActions.addWithdrawMethodField()">+ Add Method</button>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05);">
                        <button class="btn btn-success btn-block" style="padding:15px; font-size: 1.1rem;" onclick="window.adminActions.saveSettings()">
                            <i class="fas fa-save"></i> Save All Settings
                        </button>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="admin-footer">
                    Developed by <span class="developer-link" onclick="window.open('https://t.me/sojib4280', '_blank')">Sojib</span>
                </div>
            </div>`;
            renderWithdrawMethods(config.withdrawMethods);
        };
        
        const renderBroadcast = () => {
             mainContent.innerHTML = `<div id="broadcast" class="page active"><h2>Broadcast Message</h2>
                <div class="card">
                    <p>Send a message to all users. This will appear as a notification in their app.</p>
                    <div class="form-group">
                        <label>Broadcast Message</label>
                        <textarea id="broadcast-message" rows="5" placeholder="Enter your message here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Message Type</label>
                        <select id="broadcast-type">
                            <option value="info">Information</option>
                            <option value="warning">Warning</option>
                            <option value="success">Success</option>
                            <option value="danger">Important</option>
                        </select>
                    </div>
                    <button class="btn btn-danger btn-block" onclick="window.adminActions.sendBroadcast()">Send Broadcast</button>
                </div>
                
                <div class="card">
                    <h3>Recent Broadcasts</h3>
                    <div id="broadcast-history"></div>
                </div>
                
                <!-- Footer -->
                <div class="admin-footer">
                    Developed by <span class="developer-link" onclick="window.open('https://t.me/sojib4280', '_blank')">Sojib</span>
                </div>
            </div>`;
            
            loadBroadcastHistory();
        };

        const loadBroadcastHistory = async () => {
            const historyContainer = document.getElementById('broadcast-history');
            const snap = await db.ref('broadcasts').orderByChild('timestamp').limitToLast(10).once('value');
            
            let historyContent = '';
            let broadcasts = [];
            
            snap.forEach(child => {
                broadcasts.push(child.val());
            });
            
            broadcasts.reverse(); // Show newest first
            
            if (broadcasts.length === 0) {
                historyContent = '<p>No broadcast history found.</p>';
            } else {
                broadcasts.forEach(broadcast => {
                    const date = new Date(broadcast.timestamp).toLocaleString();
                    historyContent += `
                        <div class="device-info" style="margin-bottom: 10px;">
                            <strong>Date:</strong> ${date}<br>
                            <strong>Type:</strong> ${broadcast.type || 'info'}<br>
                            <strong>Message:</strong> ${broadcast.message}
                        </div>
                    `;
                });
            }
            
            historyContainer.innerHTML = historyContent;
        };

        const loadDynamicContent = async (type) => {
            const container = document.getElementById(`${type}-list`);
            const snap = await db.ref(`config/${type}`).once('value');
            let items = [];
            snap.forEach(child => { items.push({ key: child.key, ...child.val() }); });
            items.reverse(); // Show newest first
            
            let content = `<h3>Current ${type.charAt(0).toUpperCase() + type.slice(1)}</h3>`;
            if (items.length > 0) {
                content += '<div class="task-list">';
                items.forEach(item => {
                    content += `
                        <div class="task-container">
                            <div class="task-icon">
                                <i class="fas fa-link"></i>
                            </div>
                            <div class="task-info">
                                <h3>${item.name}</h3>
                                <p>${item.url}</p>
                            </div>
                            <button class="action-btn btn-danger" onclick="window.adminActions.deleteDynamicItem('${type}', '${item.key}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
                content += '</div>';
            } else { content += `<p>No ${type} found.</p>`; }
            container.innerHTML = content;
        };
        
        const renderWithdrawMethods = (methods) => {
            const container = document.getElementById('withdraw-methods-container'); 
            container.innerHTML = '';
            if (methods) {
                methods.forEach((method, index) => {
                    container.innerHTML += `<div class="withdraw-method-group" data-index="${index}"><input value="${method.name || ''}" placeholder="Method Name"><input type="number" step="any" value="${method.min || ''}" placeholder="Min Amount (BDT)"><button class="action-btn btn-danger" onclick="this.parentElement.remove()">X</button></div>`;
                });
            }
        };

        // Enhanced Task Edit Functions
        const editTask = async (taskKey) => {
            const taskSnap = await db.ref(`config/tasks/${taskKey}`).once('value');
            const task = taskSnap.val();
            
            if (!task) {
                alert('Task not found!');
                return;
            }
            
            currentEditingTaskKey = taskKey;
            
            // Fill the form with current task data
            document.getElementById('edit-task-name').value = task.name || '';
            document.getElementById('edit-task-url').value = task.url || '';
            document.getElementById('edit-task-reward').value = task.reward || 0;
            document.getElementById('edit-task-icon').value = task.icon || '';
            document.getElementById('edit-task-daily-limit').value = task.dailyLimit || 0;
            document.getElementById('edit-task-ads-break').value = task.adsPerBreak || 0;
            document.getElementById('edit-task-break-duration').value = task.breakDuration || 0;
            document.getElementById('edit-task-delay').value = task.taskDelay || 5;
            
            // Show the modal
            taskEditModal.classList.add('show');
        };

        const saveTaskChanges = async () => {
            if (!currentEditingTaskKey) {
                alert('No task selected for editing!');
                return;
            }
            
            const updatedTask = {
                name: document.getElementById('edit-task-name').value,
                url: document.getElementById('edit-task-url').value,
                reward: parseFloat(document.getElementById('edit-task-reward').value),
                icon: document.getElementById('edit-task-icon').value,
                dailyLimit: parseInt(document.getElementById('edit-task-daily-limit').value) || 0,
                adsPerBreak: parseInt(document.getElementById('edit-task-ads-break').value) || 0,
                breakDuration: parseInt(document.getElementById('edit-task-break-duration').value) || 0,
                taskDelay: parseInt(document.getElementById('edit-task-delay').value) || 5
            };
            
            if (!updatedTask.name || !updatedTask.url || !updatedTask.reward || !updatedTask.icon) {
                alert('All fields are required!');
                return;
            }
            
            try {
                await db.ref(`config/tasks/${currentEditingTaskKey}`).update(updatedTask);
                alert('Task updated successfully!');
                taskEditModal.classList.remove('show');
                renderTasks(); // Refresh the tasks list
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Failed to update task!');
            }
        };

        // Helper function to get currency symbol
        const getCurrencySymbol = (currency) => {
            const curr = currency || 'BDT';
            switch(curr) {
                case 'USD': return '$';
                case 'INR': return '';
                case 'PKR': return 'Rs';
                default: return 'TK';
            }
        };

        window.adminActions = {
            editUserBalance: async (userId, userName) => {
                const amount = prompt(`Enter amount to ADD or SUBTRACT for ${userName}.\nUse negative value to subtract (e.g., -50).`);
                if (amount && !isNaN(parseFloat(amount))) { 
                    try { 
                        await db.ref(`users/${userId}/balance`).set(firebase.database.ServerValue.increment(parseFloat(amount))); 
                        alert('Balance updated!'); 
                        renderUsers(); 
                    } catch (e) { 
                        alert('Error.'); 
                    } 
                }
            },
            
            toggleUserBlock: async (userId, isCurrentlyBlocked) => {
                const action = isCurrentlyBlocked ? 'unblock' : 'block';
                const confirmMessage = isCurrentlyBlocked ? 
                    'Are you sure you want to unblock this user?' : 
                    'Are you sure you want to block this user? Blocked users cannot access the bot.';
                
                if (confirm(confirmMessage)) {
                    try {
                        await db.ref(`users/${userId}/isBlocked`).set(!isCurrentlyBlocked);
                        alert(`User ${isCurrentlyBlocked ? 'unblocked' : 'blocked'} successfully!`);
                        renderUsers();
                    } catch (error) {
                        alert('Error updating user status.');
                    }
                }
            },
            
            sendPersonalMessage: async (userId, userName) => {
                const message = prompt(`Enter personal message for ${userName}:`);
                if (message && message.trim()) {
                    try {
                        const messageData = {
                            userId: userId,
                            message: message.trim(),
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            read: false,
                            fromAdmin: true
                        };
                        
                        await db.ref(`personalMessages/${userId}`).push(messageData);
                        alert('Personal message sent successfully!');
                    } catch (error) {
                        alert('Error sending message.');
                    }
                }
            },
            
            handleWithdrawal: async (reqId, action) => {
                const reqRef = db.ref(`withdrawals/pending/${reqId}`); 
                const snap = await reqRef.once('value'); 
                const request = snap.val();
                if (!request) { alert('Request not found.'); return; }
                if (action === 'reject') { 
                    await db.ref(`users/${request.userId}/balance`).set(firebase.database.ServerValue.increment(request.amountInBDT || request.amount));
                }
                const status = action === 'approve' ? 'completed' : 'rejected';
                await db.ref(`withdrawals/${status}/${reqId}`).set({ ...request, status });
                await reqRef.remove(); 
                alert(`Request has been ${status}.`); 
                renderWithdrawals();
            },
            
            addTask: async () => {
                const data = { 
                    name: document.getElementById('task-name').value, 
                    url: document.getElementById('task-url').value, 
                    reward: parseFloat(document.getElementById('task-reward').value), 
                    icon: document.getElementById('task-icon').value,
                    dailyLimit: parseInt(document.getElementById('task-daily-limit').value) || 0,
                    adsPerBreak: parseInt(document.getElementById('task-ads-break').value) || 0,
                    breakDuration: parseInt(document.getElementById('task-break-duration').value) || 0,
                    taskDelay: parseInt(document.getElementById('task-delay').value) || 5
                };
                if (!data.name || !data.url || !data.reward || !data.icon) { alert('All fields are required.'); return; }
                await db.ref('config/tasks').push(data); 
                alert('Task added!'); 
                renderTasks();
            },
            
            addLink: async () => {
                const data = { 
                    name: document.getElementById('link-name').value, 
                    url: document.getElementById('link-url').value, 
                    icon: document.getElementById('link-icon').value 
                };
                if (!data.name || !data.url || !data.icon) { alert('Name, URL and Icon URL are required.'); return; }
                await db.ref('config/links').push(data); 
                alert('Link added!'); 
                renderTasks();
            },
            
            deleteDynamicItem: async (type, key) => {
                if (confirm(`Are you sure you want to delete this item?`)) { 
                    await db.ref(`config/${type}/${key}`).remove(); 
                    alert('Item deleted.'); 
                    renderTasks(); 
                }
            },
            
            addWithdrawMethodField: () => {
                 document.getElementById('withdraw-methods-container').innerHTML += `<div class="withdraw-method-group"><input placeholder="Method Name"><input type="number" placeholder="Min Amount (BDT)"><button class="action-btn btn-danger" onclick="this.parentElement.remove()">X</button></div>`;
            },
            
            saveSettings: async () => {
                const withdrawMethods = [];
                document.querySelectorAll('.withdraw-method-group').forEach(group => {
                    const name = group.children[0].value; 
                    const min = parseFloat(group.children[1].value);
                    if (name && min) { withdrawMethods.push({ name, min }); }
                });
                
                const exchangeRates = {
                    USD: parseFloat(document.getElementById('usdRate').value) || 0,
                    INR: parseFloat(document.getElementById('inrRate').value) || 0,
                    PKR: parseFloat(document.getElementById('pkrRate').value) || 0
                };
                
                const settings = {
                    botUsername: document.getElementById('botUsername').value,
                    welcomeMessage: document.getElementById('welcomeMessage').value,
                    monetagEnabled: document.getElementById('monetagEnabled').checked,
                    adZoneId: document.getElementById('adZoneId').value,
                    adexoraEnabled: document.getElementById('adexoraEnabled').checked,
                    adexoraId: document.getElementById('adexoraId').value,
                    adValue: parseFloat(document.getElementById('adValue').value),
                    referralBonus: parseFloat(document.getElementById('referralBonus').value),
                    dailyAdLimit: parseInt(document.getElementById('dailyAdLimit').value),
                    adsPerBreak: parseInt(document.getElementById('adsPerBreak').value),
                    breakDuration: parseInt(document.getElementById('breakDuration').value),
                    referralSystemEnabled: document.getElementById('referralSystemEnabled').checked,
                    referralPercent: parseFloat(document.getElementById('referralPercent').value) || 10,
                    minimumWithdrawReferrals: parseInt(document.getElementById('minimumWithdrawReferrals').value) || 0,
                    autoLogoutTime: parseInt(document.getElementById('autoLogoutTime').value) || 30,
                    withdrawMethods: withdrawMethods,
                    exchangeRates: exchangeRates,
                    minBalanceForTransfer: parseFloat(document.getElementById('minBalanceForTransfer').value) || 100
                };
                await db.ref('config').update(settings); 
                
                // Update current values
                autoLogoutTime = settings.autoLogoutTime;
                if (autoLogoutTimer) {
                    resetAutoLogoutTimer();
                }
                
                alert('Settings saved successfully!');
            },
            
            sendBroadcast: async () => {
                const message = document.getElementById('broadcast-message').value;
                const type = document.getElementById('broadcast-type').value;
                
                if (!message || !confirm('Are you sure you want to send this broadcast to all users?')) { 
                    return; 
                }
                
                try {
                    const broadcastData = {
                        message: message,
                        type: type,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        sentBy: 'admin'
                    };
                    
                    await db.ref('broadcasts').push(broadcastData);
                    
                    // Also store for active users to see
                    await db.ref('activeBroadcast').set({
                        message: message,
                        type: type,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        active: true
                    });
                    
                    document.getElementById('broadcast-message').value = '';
                    alert('Broadcast sent successfully!');
                    loadBroadcastHistory();
                } catch (error) {
                    alert('Error sending broadcast: ' + error.message);
                }
            },
            
            refreshPage: () => {
                const pageMap = { 
                    dashboard: renderDashboard, 
                    users: renderUsers, 
                    devices: renderDevices,
                    withdrawals: renderWithdrawals, 
                    history: renderWithdrawalHistory, 
                    tasks: renderTasks, 
                    settings: renderSettings, 
                    broadcast: renderBroadcast 
                };
                if (pageMap[currentPage]) {
                    pageMap[currentPage]();
                    alert('Page refreshed!');
                }
            },
            
            changePassword: async () => {
                const oldPassword = document.getElementById('oldPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!oldPassword || !newPassword || !confirmPassword) {
                    alert('Please fill in all password fields.');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('New password and confirmation do not match.');
                    return;
                }
                
                if (newPassword.length < 4) {
                    alert('Password must be at least 4 characters long.');
                    return;
                }
                
                // Verify old password
                if (oldPassword !== adminPassword) {
                    alert('Current password is incorrect.');
                    return;
                }
                
                // Update password
                try {
                    await db.ref('config/adminPassword').set(newPassword);
                    adminPassword = newPassword;
                    alert('Password changed successfully!');
                    
                    // Clear password fields
                    document.getElementById('oldPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } catch (error) {
                    alert('Error changing password: ' + error.message);
                }
            },
            
            logout: () => {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('adminLoggedIn');
                    localStorage.removeItem('adminLoginTime');
                    if (autoLogoutTimer) {
                        clearInterval(autoLogoutTimer);
                    }
                    showLogin();
                }
            },
            
            editTask: editTask,
            
            renderUsers: renderUsers,
            renderWithdrawals: renderWithdrawals,
            renderSettings: renderSettings,
            renderDevices: renderDevices
        };

        const setupNavigation = () => {
            const navLinks = document.querySelectorAll('.nav-menu li');
            const pageMap = { 
                dashboard: renderDashboard, 
                users: renderUsers, 
                devices: renderDevices,
                withdrawals: renderWithdrawals, 
                history: renderWithdrawalHistory, 
                tasks: renderTasks, 
                settings: renderSettings, 
                broadcast: renderBroadcast 
            };
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const pageKey = e.currentTarget.dataset.page;
                    if (pageKey) {
                        currentPage = pageKey;
                        navLinks.forEach(l => l.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        pageTitle.textContent = e.currentTarget.textContent.trim();
                        pageMap[pageKey]();
                        sidebar.classList.remove('show'); 
                        overlay.classList.remove('show');
                    }
                });
            });
        };
        
        const setupMobileMenu = () => {
            const menuToggle = document.getElementById('menu-toggle');
            menuToggle.addEventListener('click', () => { 
                sidebar.classList.toggle('show'); 
                overlay.classList.toggle('show'); 
            });
            overlay.addEventListener('click', () => { 
                sidebar.classList.remove('show'); 
                overlay.classList.remove('show'); 
            });
        };

        const setupTopBarButtons = () => {
            refreshBtn.addEventListener('click', () => {
                window.adminActions.refreshPage();
            });
            
            // Logout button in sidebar
            document.getElementById('logout-btn').addEventListener('click', () => {
                window.adminActions.logout();
            });
        };

        // Reset auto logout timer on user activity
        document.addEventListener('click', resetAutoLogoutTimer);
        document.addEventListener('keypress', resetAutoLogoutTimer);
        document.addEventListener('mousemove', resetAutoLogoutTimer);

        // Initialize admin panel with login
        initAdminPanel();
    });
    </script>
</body>
</html>